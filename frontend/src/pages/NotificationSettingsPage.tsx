import { useState, useEffect } from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { useNotifications } from "@/hooks/useNotifications";
import { useDailyReminder } from "@/hooks/useDailyReminder";
import { useAuth } from "@/contexts/auth";
import { BellOffIcon, ArrowLeftIcon } from "lucide-react";
import { useNavigate } from "react-router-dom";
import { NotificationPermissionCard } from "@/components/notifications/NotificationPermissionCard";
import { LocalNotificationSettings } from "@/components/notifications/LocalNotificationSettings";
import { ServerNotificationSettings } from "@/components/notifications/ServerNotificationSettings";
import { STORAGE_KEYS } from "@/constants";

interface NotificationSettings {
  dailyReminder: boolean;
  dailyReminderTime: string;
  missionDeadline: boolean;
  newMission: boolean;
  newLike: boolean;
  cellMessages: boolean;
  quietHours: boolean;
  quietStart: string;
  quietEnd: string;
}

const DEFAULT_SETTINGS: NotificationSettings = {
  dailyReminder: true,
  dailyReminderTime: "09:00",
  missionDeadline: true,
  newMission: true,
  newLike: true,
  cellMessages: true,
  quietHours: false,
  quietStart: "22:00",
  quietEnd: "07:00",
};

export const NotificationSettingsPage: React.FC = () => {
  const { user } = useAuth();
  const navigate = useNavigate();
  const {
    permission,
    isSupported,
    requestPermission,
    showNotification,
    scheduleLocalNotification,
    subscribeToPush,
    unsubscribeFromPush,
  } = useNotifications();

  const { scheduleNextReminder, cancelDailyReminder } = useDailyReminder();

  // ë‹¤ìŒ ì•Œë¦¼ ì‹œê°„ ê³„ì‚°
  const getNextReminderDisplay = () => {
    if (!settings.dailyReminder || !settings.dailyReminderTime) {
      return null;
    }

    const now = new Date();
    const [hours, minutes] = settings.dailyReminderTime.split(":").map(Number);

    const nextReminder = new Date();
    nextReminder.setHours(hours, minutes, 0, 0);

    // ì˜¤ëŠ˜ ì‹œê°„ì´ ì´ë¯¸ ì§€ë‚¬ë‹¤ë©´ ë‚´ì¼ë¡œ ì„¤ì •
    if (nextReminder <= now) {
      nextReminder.setDate(nextReminder.getDate() + 1);
    }

    return nextReminder.toLocaleString("ko-KR", {
      month: "short",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit",
    });
  };

  const [settings, setSettings] =
    useState<NotificationSettings>(DEFAULT_SETTINGS);
  const [isLoading, setIsLoading] = useState(false);

  useEffect(() => {
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
    const savedSettings = localStorage.getItem(
      STORAGE_KEYS.NOTIFICATION_SETTINGS
    );
    if (savedSettings) {
      setSettings(JSON.parse(savedSettings));
    }
  }, []);

  const saveSettings = (newSettings: NotificationSettings) => {
    setSettings(newSettings);
    localStorage.setItem(
      STORAGE_KEYS.NOTIFICATION_SETTINGS,
      JSON.stringify(newSettings)
    );

    // ë§¤ì¼ ì„±ê²½ ì½ê¸° ë¦¬ë§ˆì¸ë” ì„¤ì • ë³€ê²½ ì‹œ ìŠ¤ì¼€ì¤„ ì—…ë°ì´íŠ¸
    if (newSettings.dailyReminder && newSettings.dailyReminderTime) {
      scheduleNextReminder(newSettings);
    } else {
      cancelDailyReminder();
    }
  };

  const handlePermissionRequest = async () => {
    setIsLoading(true);
    try {
      const result = await requestPermission();
      if (result === "granted") {
        await subscribeToPush();
        // í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡
        await showNotification("ì•Œë¦¼ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤!", {
          body: "Bible Daily ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
          icon: "/icons/192.png",
        });
      }
    } catch (error) {
      console.error("Failed to enable notifications:", error);
    } finally {
      setIsLoading(false);
    }
  };

  const handleDisableNotifications = async () => {
    setIsLoading(true);
    try {
      await unsubscribeFromPush();
    } catch (error) {
      console.error("Failed to disable notifications:", error);
    } finally {
      setIsLoading(false);
    }
  };

  const handleTestNotification = () => {
    showNotification("í…ŒìŠ¤íŠ¸ ì•Œë¦¼", {
      body: "ì•Œë¦¼ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤!",
      icon: "/icons/192.png",
    });
  };

  const handleScheduleTest = () => {
    scheduleLocalNotification(
      "ì˜ˆì•½ëœ ì•Œë¦¼ í…ŒìŠ¤íŠ¸",
      "5ì´ˆ í›„ì— ë„ì°©í•œ ì•Œë¦¼ì…ë‹ˆë‹¤.",
      5000
    );
  };

  const handleDailyReminderTest = () => {
    showNotification("ğŸ“– ì„±ê²½ ì½ê¸° ì‹œê°„ì…ë‹ˆë‹¤! (í…ŒìŠ¤íŠ¸)", {
      body: "ì˜¤ëŠ˜ì˜ ì„±ê²½ ë§ì”€ì„ ì½ì–´ë³´ì„¸ìš”. í•˜ë‚˜ë‹˜ì˜ ë§ì”€ìœ¼ë¡œ í•˜ë£¨ë¥¼ ì‹œì‘í•˜ì„¸ìš”.",
      icon: "/icons/192.png",
      badge: "/icons/192.png",
      tag: "daily-bible-reminder",
      requireInteraction: true,
      data: {
        type: "daily-reminder",
        timestamp: Date.now(),
      },
    } as NotificationOptions & {
      actions?: Array<{
        action: string;
        title: string;
      }>;
    });
  };

  const updateSetting = <K extends keyof NotificationSettings>(
    key: K,
    value: NotificationSettings[K]
  ) => {
    const newSettings = { ...settings, [key]: value };
    saveSettings(newSettings);
  };

  if (!user) {
    return (
      <div className="min-h-screen bg-gray-50/50 dark:bg-gray-950/50 p-4">
        <div className="max-w-md mx-auto space-y-6 pt-8">
          <Card className="border-0 shadow-sm rounded-xl">
            <CardContent className="py-16 text-center px-6">
              <div className="p-4 bg-gray-100 dark:bg-gray-800 rounded-full w-fit mx-auto mb-6">
                <BellOffIcon className="h-8 w-8 text-muted-foreground" />
              </div>
              <h3 className="text-lg font-semibold text-foreground mb-3">
                ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤
              </h3>
              <p className="text-muted-foreground text-sm leading-relaxed">
                ì•Œë¦¼ ì„¤ì •ì„ ìœ„í•´ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”
              </p>
            </CardContent>
          </Card>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50/50 dark:bg-gray-950/50">
      {/* ìƒë‹¨ í—¤ë” */}
      <div className="sticky top-0 z-10 bg-white dark:bg-gray-950 border-b border-gray-200 dark:border-gray-800">
        <div className="flex items-center px-4 py-3">
          <Button
            variant="ghost"
            size="sm"
            onClick={() => navigate(-1)}
            className="mr-2 -ml-2"
          >
            <ArrowLeftIcon className="h-5 w-5" />
          </Button>
          <div className="flex-1">
            <h1 className="text-lg font-semibold text-foreground">ì•Œë¦¼ ì„¤ì •</h1>
            <p className="text-sm text-muted-foreground">
              ë§ì¶¤í˜• ì•Œë¦¼ìœ¼ë¡œ ë” ë‚˜ì€ ê²½í—˜ì„
            </p>
          </div>
        </div>
      </div>

      <div
        className="mx-auto px-3 py-4 space-y-4 pb-24"
        style={{ marginTop: "0px" }}
      >
        {" "}
        {/* í—¤ë”ì™€ ê°„ê²© ì œê±° */}
        {/* ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ */}
        <NotificationPermissionCard
          isSupported={isSupported}
          permission={permission}
          isLoading={isLoading}
          onRequestPermission={handlePermissionRequest}
          onTestNotification={handleTestNotification}
          onScheduleTest={handleScheduleTest}
          onDailyReminderTest={handleDailyReminderTest}
          onDisableNotifications={handleDisableNotifications}
        />
        {/* ë¡œì»¬ ì•Œë¦¼ ì„¤ì • */}
        {permission === "granted" && (
          <LocalNotificationSettings
            settings={{
              dailyReminder: settings.dailyReminder,
              dailyReminderTime: settings.dailyReminderTime,
              missionDeadline: settings.missionDeadline,
              quietHours: settings.quietHours,
              quietStart: settings.quietStart,
              quietEnd: settings.quietEnd,
            }}
            onUpdateSetting={updateSetting as any}
            getNextReminderDisplay={getNextReminderDisplay}
          />
        )}
        {/* í‘¸ì‹œ ì•Œë¦¼ ì„¤ì • */}
        {permission === "granted" && (
          <ServerNotificationSettings
            settings={{
              newMission: settings.newMission,
              newLike: settings.newLike,
              cellMessages: settings.cellMessages,
            }}
            onUpdateSetting={updateSetting as any}
          />
        )}
      </div>
    </div>
  );
};
