---
description: Docker, CI/CD, ë°°í¬ ê´€ë ¨ ì¸í”„ë¼ ê·œì¹™
globs:
  - "**/Dockerfile*"
  - "**/docker-compose*.yml"
  - "**/.github/workflows/*.yml"
  - "**/deployment/**/*"
  - "**/scripts/*.sh"
  - "**/nginx/**/*"
  - "**/ssl/**/*"
  - "**/*deploy*"
  - "**/k8s/**/*"
  - "**/helm/**/*"
---

# ì¸í”„ë¼ ë° ë°°í¬ ê·œì¹™

## ğŸ“¦ íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ê·œì¹™

### pnpm ì‚¬ìš© í•„ìˆ˜

- **ëª¨ë“  Node.js í”„ë¡œì íŠ¸ì—ì„œ pnpm ì‚¬ìš©**
- npm ë˜ëŠ” yarn ëŒ€ì‹  pnpmì„ ê¸°ë³¸ íŒ¨í‚¤ì§€ ë§¤ë‹ˆì €ë¡œ ì‚¬ìš©
- ì˜ì¡´ì„± ì„¤ì¹˜: `pnpm install`
- íŒ¨í‚¤ì§€ ì¶”ê°€: `pnpm add <package>`
- ê°œë°œ ì˜ì¡´ì„± ì¶”ê°€: `pnpm add -D <package>`
- ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰: `pnpm run <script>` ë˜ëŠ” `pnpm <script>`

```bash
# âœ… ê¶Œì¥ ì‚¬ìš©ë²•
pnpm install
pnpm add dayjs
pnpm add -D @types/node
pnpm dev
pnpm build

# âŒ ì‚¬ìš© ê¸ˆì§€
npm install
yarn add
npm run dev
```

### ì‘ì—…ê³µê°„(Workspace) ì„¤ì •

- ëª¨ë…¸ë ˆí¬ êµ¬ì¡°ì—ì„œ pnpm workspace í™œìš©
- `pnpm-workspace.yaml` íŒŒì¼ë¡œ ì‘ì—…ê³µê°„ ì •ì˜
- íŒ¨í‚¤ì§€ ê°„ ì˜ì¡´ì„± ê´€ë¦¬ ìµœì í™”

```yaml
# pnpm-workspace.yaml
packages:
  - "frontend"
  - "backend"
  - "shared"
```

## ğŸ³ Docker ì»¨í…Œì´ë„ˆ ê·œì¹™

### Dockerfile ìµœì í™”

```dockerfile
# âœ… ê¶Œì¥ íŒ¨í„´
# ë©€í‹°ìŠ¤í…Œì´ì§€ ë¹Œë“œ ì‚¬ìš©
FROM node:20-alpine AS base
WORKDIR /app

# ì˜ì¡´ì„± ì„¤ì¹˜ ë‹¨ê³„
FROM base AS deps
# pnpm ì„¤ì¹˜
RUN npm install -g pnpm
COPY package*.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile --prod

# ë¹Œë“œ ë‹¨ê³„
FROM base AS build
RUN npm install -g pnpm
COPY package*.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile
COPY . .
RUN pnpm build

# ìš´ì˜ ë‹¨ê³„
FROM base AS runtime
RUN npm install -g pnpm
COPY --from=deps /app/node_modules ./node_modules
COPY --from=build /app/dist ./dist
COPY package*.json pnpm-lock.yaml ./

USER node
EXPOSE 3000
CMD ["pnpm", "start"]
```

### ë³´ì•ˆ ê·œì¹™

- ìµœì†Œ ê¶Œí•œ ì›ì¹™: `USER node` ì‚¬ìš©
- Alpine Linux ê¸°ë°˜ ì´ë¯¸ì§€ ìš°ì„  ì‚¬ìš©
- ë¶ˆí•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ê¸ˆì§€
- `.dockerignore` í™œìš©í•˜ì—¬ ë¯¼ê° íŒŒì¼ ì œì™¸
- ê³ ì • íƒœê·¸ ì‚¬ìš© (latest íƒœê·¸ ê¸ˆì§€)

### docker-compose êµ¬ì„±

```yaml
version: "3.8"
services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    depends_on:
      - backend
    restart: unless-stopped

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "4000:4000"
    environment:
      - NODE_ENV=production
    env_file:
      - .env.production
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

  db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_DATABASE}
    volumes:
      - db_data:/var/lib/mysql
      - ./database/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10
    restart: unless-stopped

volumes:
  db_data:
```

## ğŸš€ CI/CD íŒŒì´í”„ë¼ì¸ ê·œì¹™

### GitHub Actions ì›Œí¬í”Œë¡œìš°

```yaml
# .github/workflows/ci.yml
name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linting
        run: pnpm lint

      - name: Run type check
        run: pnpm type-check

      - name: Run tests
        run: pnpm test

      - name: Run E2E tests
        run: pnpm test:e2e
```

### ë°°í¬ ìë™í™” ì›ì¹™

- **ë‹¨ê³„ë³„ ë°°í¬**: ê°œë°œ â†’ ìŠ¤í…Œì´ì§• â†’ ìš´ì˜
- **ìë™ ë¡¤ë°±**: ë°°í¬ ì‹¤íŒ¨ ì‹œ ì´ì „ ë²„ì „ìœ¼ë¡œ ìë™ ë³µêµ¬
- **í™˜ê²½ë³„ ì„¤ì •**: ê° í™˜ê²½ì— ë§ëŠ” ì„¤ì • ë¶„ë¦¬
- **ë³´ì•ˆ ê²€ì‚¬**: ë³´ì•ˆ ì·¨ì•½ì  ìë™ ìŠ¤ìº”
- **ì„±ëŠ¥ í…ŒìŠ¤íŠ¸**: ë¶€í•˜ í…ŒìŠ¤íŠ¸ ìë™ ì‹¤í–‰

## ğŸŒ ì›¹ì„œë²„ ë° í”„ë¡ì‹œ ì„¤ì •

### Nginx ìµœì í™” ì„¤ì •

```nginx
# nginx.conf
server {
    listen 80;
    listen [::]:80;
    server_name bible-daily.com www.bible-daily.com;

    # HTTPS ë¦¬ë‹¤ì´ë ‰íŠ¸
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name bible-daily.com www.bible-daily.com;

    # SSL ì„¤ì •
    ssl_certificate /etc/letsencrypt/live/bible-daily.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/bible-daily.com/privkey.pem;

    # ë³´ì•ˆ í—¤ë”
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Gzip ì••ì¶•
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/json;

    # ì •ì  íŒŒì¼ ìºì‹±
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # API í”„ë¡ì‹œ
    location /api/ {
        proxy_pass http://backend:4000/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # íƒ€ì„ì•„ì›ƒ ì„¤ì •
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # í”„ë¡ íŠ¸ì—”ë“œ SPA ì„¤ì •
    location / {
        proxy_pass http://frontend:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;

        # SPA ë¼ìš°íŒ… ì§€ì›
        try_files $uri $uri/ /index.html;
    }
}
```

## ğŸ“Š ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹…

### ë¡œê·¸ ê´€ë¦¬ ê·œì¹™

```yaml
# docker-composeì— ë¡œê¹… ì„¤ì •
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
    labels: "service=backend"
```

### í—¬ìŠ¤ì²´í¬ êµ¬í˜„

```typescript
// backend/src/health.controller.ts
@Controller("health")
export class HealthController {
  @Get()
  getHealth() {
    return {
      status: "ok",
      timestamp: new Date().toISOString(),
      uptime: process.uptime(),
      version: process.env.npm_package_version,
    };
  }

  @Get("db")
  async getDatabaseHealth() {
    // ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ìƒíƒœ í™•ì¸
    return { status: "ok", database: "connected" };
  }
}
```

## ğŸ”’ SSL/TLS ë° ë³´ì•ˆ

### Let's Encrypt ìë™ ê°±ì‹ 

```bash
#!/bin/bash
# scripts/ssl-renew.sh
certbot renew --nginx --quiet

# Nginx ì¬ì‹œì‘
docker-compose exec nginx nginx -s reload

# ë¡œê·¸ ê¸°ë¡
echo "$(date): SSL certificate renewed" >> /var/log/ssl-renew.log
```

### ë³´ì•ˆ ìŠ¤ìº” ìë™í™”

```yaml
# .github/workflows/security.yml
name: Security Scan

on:
  schedule:
    - cron: "0 2 * * 1" # ë§¤ì£¼ ì›”ìš”ì¼ 2AM
  push:
    branches: [main]

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Upload to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: "trivy-results.sarif"
```

## ğŸ“ˆ ìŠ¤ì¼€ì¼ë§ ë° ì„±ëŠ¥

### ìˆ˜í‰ í™•ì¥ ì„¤ì •

```yaml
# docker-compose.scale.yml
version: "3.8"
services:
  backend:
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

  nginx:
    # ë¡œë“œ ë°¸ëŸ°ì‹± ì„¤ì •
    volumes:
      - ./nginx/load-balancer.conf:/etc/nginx/nginx.conf
```

### ìºì‹± ì „ëµ

```nginx
# Redis ìºì‹±
location /api/cache/ {
    set $redis_key "$uri$is_args$args";
    redis_pass redis:6379;
    default_type application/json;
    error_page 404 502 504 = @fallback;
}

location @fallback {
    proxy_pass http://backend:4000;
}
```

## ğŸ”§ í™˜ê²½ë³„ ë°°í¬ ì„¤ì •

### í™˜ê²½ ë¶„ë¦¬ ì „ëµ

```bash
# ê°œë°œ í™˜ê²½
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

# ìŠ¤í…Œì´ì§• í™˜ê²½
docker-compose -f docker-compose.yml -f docker-compose.staging.yml up

# ìš´ì˜ í™˜ê²½
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up
```

### í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬

```yaml
# deployment/environments/production.yml
apiVersion: v1
kind: Secret
metadata:
  name: bible-daily-secrets
type: Opaque
stringData:
  DB_PASSWORD: ${DB_PASSWORD}
  JWT_SECRET: ${JWT_SECRET}
  ENCRYPTION_KEY: ${ENCRYPTION_KEY}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: bible-daily-config
data:
  NODE_ENV: "production"
  DB_HOST: "mysql-service"
  DB_PORT: "3306"
  DB_DATABASE: "bible_daily"
```

## ğŸš¨ ì¬í•´ ë³µêµ¬ ë° ë°±ì—…

### ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…

```bash
#!/bin/bash
# scripts/backup-db.sh
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backups"

# MySQL ë°±ì—…
docker-compose exec db mysqldump -u root -p${DB_ROOT_PASSWORD} bible_daily > ${BACKUP_DIR}/bible_daily_${DATE}.sql

# 7ì¼ ì´ìƒëœ ë°±ì—… íŒŒì¼ ì‚­ì œ
find ${BACKUP_DIR} -name "bible_daily_*.sql" -mtime +7 -delete

echo "Backup completed: bible_daily_${DATE}.sql"
```

### ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼

```yaml
# docker-compose.monitoring.yml
version: "3.8"
services:
  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml

  grafana:
    image: grafana/grafana
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
    volumes:
      - grafana-data:/var/lib/grafana

volumes:
  grafana-data:
```
