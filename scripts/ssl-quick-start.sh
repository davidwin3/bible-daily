#!/bin/bash

# Quick Start Script for Let's Encrypt SSL Setup
# This script provides an interactive setup for SSL certificates

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
ENV_FILE="$PROJECT_ROOT/.env"

# Functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_step() {
    echo -e "${CYAN}[STEP]${NC} $1"
}

# Welcome message
show_welcome() {
    echo -e "${GREEN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                    Bible Daily SSL Setup                    â•‘"
    echo "â•‘              Let's Encrypt ìë™ ì¸ì¦ì„œ ë°œê¸‰                  â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo
}

# Collect user input
collect_domain_info() {
    log_step "ë„ë©”ì¸ ì •ë³´ ì…ë ¥"
    echo
    
    # Primary domain
    while true; do
        read -p "ì£¼ ë„ë©”ì¸ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: bible-daily.com): " DOMAIN
        if [[ $DOMAIN =~ ^[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9]\.[a-zA-Z]{2,}$ ]]; then
            break
        else
            log_error "ì˜¬ë°”ë¥¸ ë„ë©”ì¸ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."
        fi
    done
    
    # Additional domains
    echo
    log_info "ì¶”ê°€ ë„ë©”ì¸ì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)"
    log_info "ì—¬ëŸ¬ ë„ë©”ì¸ì€ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì„¸ìš” (ì˜ˆ: www.bible-daily.com,api.bible-daily.com)"
    read -p "ì¶”ê°€ ë„ë©”ì¸ (Enterë¡œ ê±´ë„ˆë›°ê¸°): " ADDITIONAL_DOMAINS
    
    # Email
    echo
    while true; do
        read -p "Let's Encrypt ì•Œë¦¼ìš© ì´ë©”ì¼: " CERTBOT_EMAIL
        if [[ $CERTBOT_EMAIL =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
            break
        else
            log_error "ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."
        fi
    done
    
    # Staging option
    echo
    log_info "í…ŒìŠ¤íŠ¸ í™˜ê²½ì„ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ê¶Œì¥: ì²˜ìŒ ì„¤ì • ì‹œ 'y')"
    log_warning "í…ŒìŠ¤íŠ¸ í™˜ê²½ì€ ì¸ì¦ì„œ ë°œê¸‰ ì œí•œì´ ì—†ì§€ë§Œ, ë¸Œë¼ìš°ì €ì—ì„œ ì‹ ë¢°ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
    read -p "í…ŒìŠ¤íŠ¸ í™˜ê²½ ì‚¬ìš© (y/N): " use_staging
    
    if [[ $use_staging =~ ^[Yy]$ ]]; then
        CERTBOT_STAGING=1
        log_warning "í…ŒìŠ¤íŠ¸ í™˜ê²½ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
    else
        CERTBOT_STAGING=0
        log_info "ìš´ì˜ í™˜ê²½ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
    fi
}

# Show configuration summary
show_summary() {
    echo
    log_step "ì„¤ì • ìš”ì•½"
    echo
    echo -e "${CYAN}ì£¼ ë„ë©”ì¸:${NC} $DOMAIN"
    if [ ! -z "$ADDITIONAL_DOMAINS" ]; then
        echo -e "${CYAN}ì¶”ê°€ ë„ë©”ì¸:${NC} $ADDITIONAL_DOMAINS"
    fi
    echo -e "${CYAN}ì´ë©”ì¼:${NC} $CERTBOT_EMAIL"
    echo -e "${CYAN}í™˜ê²½:${NC} $([ $CERTBOT_STAGING -eq 1 ] && echo "í…ŒìŠ¤íŠ¸" || echo "ìš´ì˜")"
    echo
    
    read -p "ìœ„ ì„¤ì •ìœ¼ë¡œ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Y/n): " confirm
    if [[ $confirm =~ ^[Nn]$ ]]; then
        log_info "ì„¤ì •ì„ ì·¨ì†Œí•©ë‹ˆë‹¤."
        exit 0
    fi
}

# Create .env file
create_env_file() {
    log_step ".env íŒŒì¼ ìƒì„±"
    
    # Backup existing .env file
    if [ -f "$ENV_FILE" ]; then
        cp "$ENV_FILE" "$ENV_FILE.backup.$(date +%Y%m%d_%H%M%S)"
        log_info "ê¸°ì¡´ .env íŒŒì¼ì„ ë°±ì—…í–ˆìŠµë‹ˆë‹¤."
    fi
    
    # Create new .env file
    cat > "$ENV_FILE" << EOF
# Bible Daily Configuration
# Generated by ssl-quick-start.sh on $(date)

# SSL Configuration with Let's Encrypt
DOMAIN=$DOMAIN
$([ ! -z "$ADDITIONAL_DOMAINS" ] && echo "ADDITIONAL_DOMAINS=$ADDITIONAL_DOMAINS")

# Let's Encrypt Configuration
CERTBOT_EMAIL=$CERTBOT_EMAIL
CERTBOT_STAGING=$CERTBOT_STAGING

# SSL Certificate Paths (automatically managed by Let's Encrypt)
SSL_CERT_PATH=/etc/letsencrypt/live/$DOMAIN/fullchain.pem
SSL_KEY_PATH=/etc/letsencrypt/live/$DOMAIN/privkey.pem
USE_LETSENCRYPT=true

# Database Configuration (update these values)
DB_ROOT_PASSWORD=your_secure_root_password
DB_USERNAME=bible_user
DB_PASSWORD=your_secure_password
DB_DATABASE=bible_daily
DB_PORT=3306

# Redis Configuration
REDIS_PASSWORD=your_secure_redis_password
REDIS_PORT=6379

# JWT Configuration
JWT_SECRET=your_super_secret_jwt_key_here
JWT_REFRESH_SECRET=your_super_secret_refresh_key_here

# Firebase Configuration (update these values)
FIREBASE_PROJECT_ID=your-project-id
FIREBASE_PRIVATE_KEY_ID=your-private-key-id
FIREBASE_PRIVATE_KEY=your-private-key
FIREBASE_CLIENT_EMAIL=your-client-email
FIREBASE_CLIENT_ID=your-client-id

# CORS Configuration
CORS_ORIGIN=https://$DOMAIN

# Build Configuration
FRONTEND_IMAGE=ghcr.io/davidwin3/bible-daily/frontend:latest
BACKEND_IMAGE=ghcr.io/davidwin3/bible-daily/backend:latest
BUILD_VERSION=latest
EOF
    
    log_success ".env íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
    log_warning "ë°ì´í„°ë² ì´ìŠ¤, Redis, JWT, Firebase ì„¤ì •ì„ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”."
}

# Check prerequisites
check_prerequisites() {
    log_step "ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­ í™•ì¸"
    
    # Check if running as root
    if [[ $EUID -ne 0 ]]; then
        log_error "ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” root ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤. (sudo ì‚¬ìš©)"
        exit 1
    fi
    
    # Check Docker
    if ! command -v docker &> /dev/null; then
        log_error "Dockerê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        exit 1
    fi
    
    # Check Docker Compose
    if ! command -v docker-compose &> /dev/null; then
        log_error "Docker Composeê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        exit 1
    fi
    
    # Check DNS resolution
    log_info "DNS í•´ìƒë„ í™•ì¸ ì¤‘..."
    if ! nslookup "$DOMAIN" &> /dev/null; then
        log_warning "ë„ë©”ì¸ '$DOMAIN'ì˜ DNS í•´ìƒë„ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        log_warning "ë„ë©”ì¸ì´ ì´ ì„œë²„ì˜ IPë¥¼ ê°€ë¦¬í‚¤ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”."
        read -p "ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " continue_anyway
        if [[ ! $continue_anyway =~ ^[Yy]$ ]]; then
            exit 1
        fi
    else
        log_success "DNS í•´ìƒë„ í™•ì¸ ì™„ë£Œ"
    fi
    
    log_success "ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­ í™•ì¸ ì™„ë£Œ"
}

# Run SSL setup
run_ssl_setup() {
    log_step "SSL ì„¤ì • ì‹¤í–‰"
    
    cd "$PROJECT_ROOT"
    
    if [ -f "./scripts/ssl-setup.sh" ]; then
        log_info "SSL ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
        ./scripts/ssl-setup.sh
    else
        log_error "SSL ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        exit 1
    fi
}

# Show next steps
show_next_steps() {
    echo
    log_success "SSL ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰"
    echo
    log_step "ë‹¤ìŒ ë‹¨ê³„"
    echo
    echo "1. ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸:"
    echo "   docker-compose -f docker-compose.ssl.yml ps"
    echo
    echo "2. SSL ì¸ì¦ì„œ ìƒíƒœ í™•ì¸:"
    echo "   ./scripts/ssl-status.sh"
    echo
    echo "3. ì›¹ì‚¬ì´íŠ¸ ì ‘ì†:"
    echo "   https://$DOMAIN"
    if [ ! -z "$ADDITIONAL_DOMAINS" ]; then
        for domain in $(echo "$ADDITIONAL_DOMAINS" | tr ',' ' '); do
            domain=$(echo "$domain" | xargs)
            echo "   https://$domain"
        done
    fi
    echo
    echo "4. ë¡œê·¸ í™•ì¸:"
    echo "   docker-compose -f docker-compose.ssl.yml logs -f"
    echo
    
    if [ $CERTBOT_STAGING -eq 1 ]; then
        log_warning "í…ŒìŠ¤íŠ¸ í™˜ê²½ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤."
        log_info "ìš´ì˜ í™˜ê²½ìœ¼ë¡œ ì „í™˜í•˜ë ¤ë©´:"
        echo "   1. .env íŒŒì¼ì—ì„œ CERTBOT_STAGING=0ìœ¼ë¡œ ë³€ê²½"
        echo "   2. docker-compose -f docker-compose.ssl.yml down"
        echo "   3. sudo rm -rf /opt/bible-daily/ssl/letsencrypt/live/$DOMAIN"
        echo "   4. docker-compose -f docker-compose.ssl.yml up -d"
    fi
    
    echo
    log_info "ë¬¸ì œê°€ ë°œìƒí•˜ë©´ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…í•˜ì„¸ìš”:"
    echo "   ./scripts/ssl-status.sh"
    echo "   docker-compose -f docker-compose.ssl.yml logs certbot"
}

# Main function
main() {
    show_welcome
    collect_domain_info
    show_summary
    check_prerequisites
    create_env_file
    run_ssl_setup
    show_next_steps
}

# Show usage
usage() {
    echo "Usage: $0 [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  -h, --help     Show this help message"
    echo "  --non-interactive  Run in non-interactive mode (requires env vars)"
    echo ""
    echo "Environment variables for non-interactive mode:"
    echo "  DOMAIN                Primary domain"
    echo "  ADDITIONAL_DOMAINS    Additional domains (comma-separated)"
    echo "  CERTBOT_EMAIL         Email for Let's Encrypt"
    echo "  CERTBOT_STAGING       Use staging environment (0 or 1)"
}

# Parse command line arguments
INTERACTIVE=true

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            usage
            exit 0
            ;;
        --non-interactive)
            INTERACTIVE=false
            shift
            ;;
        *)
            log_error "Unknown option: $1"
            usage
            exit 1
            ;;
    esac
done

# Run main function
if [ "$INTERACTIVE" = true ]; then
    main "$@"
else
    # Non-interactive mode
    if [ -z "$DOMAIN" ] || [ -z "$CERTBOT_EMAIL" ]; then
        log_error "Non-interactive mode requires DOMAIN and CERTBOT_EMAIL environment variables"
        exit 1
    fi
    
    CERTBOT_STAGING=${CERTBOT_STAGING:-0}
    create_env_file
    check_prerequisites
    run_ssl_setup
    show_next_steps
fi
